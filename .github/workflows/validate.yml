name: Validate HTML

on:
  push:
    paths:
      - '**.html'

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install HTML validator
        run: |
          echo "Installation de html-validate..."
          npm install -g html-validate || {
            echo "√âchec de l'installation de html-validate, installation d'une alternative..."
            npm install -g htmlhint
          }

      - name: Run HTML validation
        run: |
          echo "# Feedback Automatis√©" > feedback.md
          echo "" >> feedback.md
          echo "## R√©sultats de la validation HTML :" >> feedback.md
          echo "" >> feedback.md
          
          # Chercher tous les fichiers HTML
          html_files=$(find . -name "*.html" -not -path "./.git/*")
          if [ -z "$html_files" ]; then
            echo "‚ùå Aucun fichier HTML trouv√© dans le repository." >> feedback.md
          else
            echo "üìÅ **Fichiers HTML analys√©s** :" >> feedback.md
            for file in $html_files; do
              echo "- $file" >> feedback.md
            done
            echo "" >> feedback.md
            
            # Debug: v√©rifier que html-validate est install√©
            echo "Debug: V√©rification de html-validate..."
            if command -v html-validate >/dev/null 2>&1; then
              echo "Debug: html-validate trouv√©, utilisation..."
              # Analyser chaque fichier individuellement pour √©viter les probl√®mes
              validation_errors=false
              for file in $html_files; do
                echo "Debug: Analyse de $file avec html-validate..."
                if html-validate "$file" > "validation_${file##*/}.tmp" 2>&1; then
                  if [ -s "validation_${file##*/}.tmp" ]; then
                    echo "‚ö†Ô∏è **Erreurs dans $file** :" >> feedback.md
                    echo '```' >> feedback.md
                    cat "validation_${file##*/}.tmp" >> feedback.md
                    echo '```' >> feedback.md
                    validation_errors=true
                  fi
                else
                  echo "‚ö†Ô∏è **Erreurs dans $file** :" >> feedback.md
                  echo '```' >> feedback.md
                  cat "validation_${file##*/}.tmp" >> feedback.md
                  echo '```' >> feedback.md
                  validation_errors=true
                fi
                rm -f "validation_${file##*/}.tmp"
              done
            elif command -v htmlhint >/dev/null 2>&1; then
              echo "Debug: html-validate non trouv√©, utilisation de htmlhint..."
              validation_errors=false
              for file in $html_files; do
                echo "Debug: Analyse de $file avec htmlhint..."
                if ! htmlhint "$file" > "validation_${file##*/}.tmp" 2>&1; then
                  echo "‚ö†Ô∏è **Erreurs dans $file** :" >> feedback.md
                  echo '```' >> feedback.md
                  cat "validation_${file##*/}.tmp" >> feedback.md
                  echo '```' >> feedback.md
                  validation_errors=true
                fi
                rm -f "validation_${file##*/}.tmp"
              done
            else
              echo "‚ö†Ô∏è **Validation basique** : Aucun validateur HTML install√©" >> feedback.md
              validation_errors=false
            fi
            
            if [ "$validation_errors" = false ]; then
              echo "‚úÖ **Aucune erreur de validation HTML d√©tect√©e !**" >> feedback.md
              echo "Votre code HTML semble correct." >> feedback.md
            fi
          fi
          echo "" >> feedback.md

      - name: Analyze validation errors and provide solutions
        run: |
          echo "## üîß Solutions aux erreurs de validation d√©tect√©es :" >> feedback.md
          echo "" >> feedback.md
          
          html_files=$(find . -name "*.html" -not -path "./.git/*")
          solutions_provided=false
          
          for file in $html_files; do
            # Analyser le contenu pour d√©tecter des probl√®mes sp√©cifiques
            
            # 1. Images sans alt
            if grep -q '<img[^>]*>' "$file" && ! grep -q '<img[^>]*alt=' "$file"; then
              echo "### ‚ôø **Erreur d'accessibilit√© : Images sans attribut alt**" >> feedback.md
              echo "" >> feedback.md
              echo "**Probl√®me d√©tect√© :** \`<img>\` sans attribut \`alt\`" >> feedback.md
              echo "" >> feedback.md
              echo "**Solution :**" >> feedback.md
              echo '```html' >> feedback.md
              echo "<!-- ‚ùå Erreur actuelle -->" >> feedback.md
              grep -o '<img[^>]*>' "$file" | head -1 >> feedback.md
              echo "" >> feedback.md
              echo "<!-- ‚úÖ Correction -->" >> feedback.md
              img_line=$(grep -o '<img[^>]*>' "$file" | head -1)
              corrected_img=$(echo "$img_line" | sed 's/>/ alt="Description de l'\''image">/')
              echo "$corrected_img" >> feedback.md
              echo '```' >> feedback.md
              echo "" >> feedback.md
              solutions_provided=true
            fi
            
            # 2. Balises non ferm√©es
            if grep -q '<p>' "$file"; then
              # V√©rifier s'il y a des <p> potentiellement non ferm√©s
              p_open=$(grep -c '<p>' "$file" 2>/dev/null || echo "0")
              p_close=$(grep -c '</p>' "$file" 2>/dev/null || echo "0")
              if [ "$p_open" -gt "$p_close" ]; then
                echo "### üîó **Erreur de structure : Balise \`<p>\` non ferm√©e**" >> feedback.md
                echo "" >> feedback.md
                echo "**Probl√®me d√©tect√© :** Balise \`<p>\` ouverte mais pas ferm√©e correctement" >> feedback.md
                echo "" >> feedback.md
                echo "**Solution :** Ajouter la balise de fermeture \`</p>\`" >> feedback.md
                echo '```html' >> feedback.md
                echo "<!-- ‚ùå Erreur -->" >> feedback.md
                echo "<p>" >> feedback.md
                echo "  Votre texte..." >> feedback.md
                echo "<!-- Pas de fermeture -->" >> feedback.md
                echo "" >> feedback.md
                echo "<!-- ‚úÖ Correction -->" >> feedback.md
                echo "<p>" >> feedback.md
                echo "  Votre texte..." >> feedback.md
                echo "</p>" >> feedback.md
                echo '```' >> feedback.md
                echo "" >> feedback.md
                solutions_provided=true
              fi
            fi
            
            # 3. Balises li non ferm√©es
            if grep -q '<li>' "$file"; then
              li_open=$(grep -c '<li>' "$file" 2>/dev/null || echo "0")
              li_close=$(grep -c '</li>' "$file" 2>/dev/null || echo "0")
              if [ "$li_open" -gt "$li_close" ]; then
                echo "### üìù **Erreur de liste : Balise \`<li>\` non ferm√©e**" >> feedback.md
                echo "" >> feedback.md
                echo "**Probl√®me d√©tect√© :** √âl√©ment de liste sans balise de fermeture" >> feedback.md
                echo "" >> feedback.md
                echo "**Solution :** Ajouter \`</li>\` √† chaque √©l√©ment" >> feedback.md
                echo '```html' >> feedback.md
                echo "<!-- ‚ùå Erreur -->" >> feedback.md
                echo "<ul>" >> feedback.md
                echo "  <li>Premier √©l√©ment" >> feedback.md
                echo "  <li>Deuxi√®me √©l√©ment</li>" >> feedback.md
                echo "</ul>" >> feedback.md
                echo "" >> feedback.md
                echo "<!-- ‚úÖ Correction -->" >> feedback.md
                echo "<ul>" >> feedback.md
                echo "  <li>Premier √©l√©ment</li>" >> feedback.md
                echo "  <li>Deuxi√®me √©l√©ment</li>" >> feedback.md
                echo "</ul>" >> feedback.md
                echo '```' >> feedback.md
                echo "" >> feedback.md
                solutions_provided=true
              fi
            fi
            
            # 4. Balises blockquote non ferm√©es
            if grep -q '<blockquote>' "$file"; then
              bq_open=$(grep -c '<blockquote>' "$file" 2>/dev/null || echo "0")
              bq_close=$(grep -c '</blockquote>' "$file" 2>/dev/null || echo "0")
              if [ "$bq_open" -gt "$bq_close" ]; then
                echo "### üí¨ **Erreur de citation : Balise \`<blockquote>\` non ferm√©e**" >> feedback.md
                echo "" >> feedback.md
                echo "**Probl√®me d√©tect√© :** Citation ouverte mais pas ferm√©e" >> feedback.md
                echo "" >> feedback.md
                echo "**Solution :** Ajouter \`</blockquote>\` avant la fermeture du conteneur" >> feedback.md
                echo '```html' >> feedback.md
                echo "<!-- ‚ùå Erreur -->" >> feedback.md
                echo "<footer>" >> feedback.md
                echo "  <blockquote>" >> feedback.md
                echo "    \"Votre citation...\"" >> feedback.md
                echo "  <!-- Manque </blockquote> -->" >> feedback.md
                echo "</footer>" >> feedback.md
                echo "" >> feedback.md
                echo "<!-- ‚úÖ Correction -->" >> feedback.md
                echo "<footer>" >> feedback.md
                echo "  <blockquote>" >> feedback.md
                echo "    \"Votre citation...\"" >> feedback.md
                echo "  </blockquote>" >> feedback.md
                echo "</footer>" >> feedback.md
                echo '```' >> feedback.md
                echo "" >> feedback.md
                solutions_provided=true
              fi
            fi
            
            # 5. Espaces en fin de ligne
            if grep -q '[[:space:]]$' "$file"; then
              echo "### üßπ **Probl√®me de formatage : Espaces en fin de ligne**" >> feedback.md
              echo "" >> feedback.md
              echo "**Probl√®me d√©tect√© :** Espaces inutiles √† la fin des lignes" >> feedback.md
              echo "" >> feedback.md
              echo "**Solution :** Supprimer les espaces en fin de ligne" >> feedback.md
              echo "- Dans VS Code : Rechercher avec regex \`[[:space:]]+$\` et remplacer par rien" >> feedback.md
              echo "- Ou configurer VS Code pour supprimer automatiquement les espaces" >> feedback.md
              echo "" >> feedback.md
              solutions_provided=true
            fi
          done
          
          if [ "$solutions_provided" = false ]; then
            echo "‚úÖ **Aucune erreur de validation sp√©cifique d√©tect√©e !**" >> feedback.md
            echo "Votre code HTML semble bien structur√©." >> feedback.md
          fi
          echo "" >> feedback.md

      - name: Analyze HTML code quality
        run: |
          echo "## Analyse de la qualit√© du code :" >> feedback.md
          echo "" >> feedback.md
          
          html_files=$(find . -name "*.html" -not -path "./.git/*")
          
          for file in $html_files; do
            echo "### üìÑ Analyse de \`$file\` :" >> feedback.md
            echo "" >> feedback.md
            
            # Points forts
            echo "#### ‚úÖ **Points forts d√©tect√©s** :" >> feedback.md
            
            # V√©rifier DOCTYPE
            if grep -q "<!DOCTYPE html>" "$file"; then
              echo "- ‚úÖ D√©claration DOCTYPE HTML5 pr√©sente" >> feedback.md
            fi
            
            # V√©rifier lang
            if grep -q '<html.*lang=' "$file"; then
              echo "- ‚úÖ Attribut lang d√©fini pour l'accessibilit√©" >> feedback.md
            fi
            
            # V√©rifier charset
            if grep -q 'charset=' "$file"; then
              echo "- ‚úÖ Encodage de caract√®res sp√©cifi√©" >> feedback.md
            fi
            
            # V√©rifier viewport
            if grep -q 'viewport' "$file"; then
              echo "- ‚úÖ Meta viewport pr√©sent (responsive design)" >> feedback.md
            fi
            
            # V√©rifier balises s√©mantiques
            semantic_tags=("header" "main" "footer" "nav" "section" "article" "aside")
            for tag in "${semantic_tags[@]}"; do
              if grep -q "<$tag" "$file"; then
                echo "- ‚úÖ Utilisation de balises s√©mantiques (\`<$tag>\`)" >> feedback.md
              fi
            done
            
            # V√©rifier structure de base
            if grep -q "<title>" "$file"; then
              echo "- ‚úÖ Titre de page d√©fini" >> feedback.md
            fi
            
            echo "" >> feedback.md
            
            # Points √† am√©liorer
            echo "#### ‚ö†Ô∏è **Points √† am√©liorer** :" >> feedback.md
            
            issues_found=false
            
            # V√©rifier images sans alt
            if grep -q '<img' "$file" && ! grep -q '<img[^>]*alt=' "$file"; then
              echo "- ‚ö†Ô∏è Images sans attribut alt d√©tect√©es" >> feedback.md
              issues_found=true
            fi
            
            # V√©rifier balises obsol√®tes
            obsolete_tags=("font" "center" "b" "i" "u")
            for tag in "${obsolete_tags[@]}"; do
              if grep -q "<$tag" "$file"; then
                echo "- ‚ö†Ô∏è Balise obsol√®te d√©tect√©e : \`<$tag>\` (utiliser CSS √† la place)" >> feedback.md
                issues_found=true
              fi
            done
            
            # V√©rifier styles inline
            if grep -q 'style=' "$file"; then
              echo "- ‚ö†Ô∏è Styles inline d√©tect√©s (consid√©rer l'externalisation CSS)" >> feedback.md
              issues_found=true
            fi
            
            # V√©rifier liens sans title ou texte descriptif
            if grep -q '<a.*href.*>' "$file"; then
              if ! grep -q '<a.*title=' "$file"; then
                echo "- ‚ÑπÔ∏è Consid√©rer l'ajout d'attributs title aux liens pour l'accessibilit√©" >> feedback.md
                issues_found=true
              fi
            fi
            
            if [ "$issues_found" = false ]; then
              echo "- ‚úÖ Aucun probl√®me majeur d√©tect√© dans ce fichier !" >> feedback.md
            fi
            
            echo "" >> feedback.md
          done

      - name: Check for alt attributes in images
        run: |
          echo "## V√©rification d√©taill√©e des images :" >> feedback.md
          echo "" >> feedback.md
          
          # Chercher les images dans les fichiers HTML
          html_files=$(find . -name "*.html" -not -path "./.git/*")
          images_found=false
          
          for file in $html_files; do
            if grep -q '<img' "$file" 2>/dev/null; then
              images_found=true
              echo "üñºÔ∏è **Images dans $file** :" >> feedback.md
              
              # Extraire toutes les balises img
              grep -o '<img[^>]*>' "$file" | while IFS= read -r img_tag; do
                if echo "$img_tag" | grep -q 'alt='; then
                  echo "  ‚úÖ Image avec attribut alt : \`$img_tag\`" >> feedback.md
                else
                  echo "  ‚ùå **Image sans attribut alt** : \`$img_tag\`" >> feedback.md
                  echo "    üí° **Suggestion** : Ajouter \`alt=\"Description de l'image\"\`" >> feedback.md
                fi
              done
              echo "" >> feedback.md
            fi
          done
          
          if [ "$images_found" = false ]; then
            echo "‚ÑπÔ∏è Aucune image trouv√©e dans les fichiers HTML." >> feedback.md
          fi
          echo "" >> feedback.md

      - name: Generate personalized recommendations  
        run: |
          echo "## üí° Recommandations personnalis√©es :" >> feedback.md
          echo "" >> feedback.md
          echo "### Actions prioritaires :" >> feedback.md
          
          html_files=$(find . -name "*.html" -not -path "./.git/*")
          priority_actions=false
          
          for file in $html_files; do
            if grep -q '<img' "$file" && ! grep -q 'alt=' "$file"; then
              echo "- ‚ôø **Urgent** : Ajouter des attributs \`alt\` aux images dans \`$file\`" >> feedback.md
              priority_actions=true
            fi
            
            if ! grep -q 'viewport' "$file"; then
              echo "- üì± **Recommand√©** : Ajouter la meta viewport dans \`$file\` pour le responsive" >> feedback.md
              priority_actions=true
            fi
          done
          
          if [ "$priority_actions" = false ]; then
            echo "‚úÖ Aucune action prioritaire n√©cessaire !" >> feedback.md
          fi
          echo "" >> feedback.md

      - name: Add pedagogical feedback with code examples
        run: |
          cat >> feedback.md << 'EOF'
          ## üìö Guide de r√©solution des erreurs courantes :
          
          ### üéØ **Erreurs fr√©quentes et leurs solutions** :
          
          #### 1. Erreur `wcag/h37` - Images sans attribut alt
          **Cause :** L'attribut `alt` est obligatoire pour l'accessibilit√©
          ```html
          <!-- ‚ùå Probl√®me -->
          <img src="image.jpg">
          
          <!-- ‚úÖ Solution -->
          <img src="image.jpg" alt="Nelson Mandela souriant en 2008">
          ```
          
          #### 2. Erreur `no-implicit-close` - Balises non ferm√©es
          **Cause :** HTML5 ferme automatiquement certaines balises, mais c'est une mauvaise pratique
          ```html
          <!-- ‚ùå Probl√®me -->
          <p>Texte
          <h2>Titre</h2>
          
          <!-- ‚úÖ Solution -->
          <p>Texte</p>
          <h2>Titre</h2>
          ```
          
          #### 3. Erreur `close-order` - Ordre de fermeture incorrect
          **Cause :** Les balises doivent √™tre ferm√©es dans l'ordre inverse d'ouverture
          ```html
          <!-- ‚ùå Probl√®me -->
          <footer>
            <blockquote>
              Citation...
          </footer> <!-- blockquote jamais ferm√© -->
          
          <!-- ‚úÖ Solution -->
          <footer>
            <blockquote>
              Citation...
            </blockquote>
          </footer>
          ```
          
          #### 4. Erreur `no-trailing-whitespace` - Espaces en fin de ligne
          **Cause :** Espaces inutiles √† la fin des lignes
          **Solution :** Configurez votre √©diteur pour supprimer automatiquement ces espaces
          
          ### üí° **Conseils pour √©viter ces erreurs** :
          
          - **Utilisez un √©diteur avec coloration syntaxique** (VS Code, Sublime Text, etc.)
          - **Activez l'auto-completion HTML** pour les balises de fermeture
          - **Installez des extensions** comme "Auto Close Tag" dans VS Code
          - **Utilisez l'indentation** pour visualiser la structure
          - **Validez r√©guli√®rement** votre code pendant le d√©veloppement
          
          ### üîß **Configuration VS Code recommand√©e** :
          ```json
          {
            "files.trimTrailingWhitespace": true,
            "editor.formatOnSave": true,
            "html.autoClosingTags": true
          }
          ```
          
          EOF

      - name: Commit feedback
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add feedback.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add automated feedback"
            git push
          fi
